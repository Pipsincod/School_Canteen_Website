{% extends 'base.html' %}

{% block title %}–ü–∏—Ç–∞–Ω–∏–µ –ø–æ –ø–æ–¥–ø–∏—Å–∫–µ | –£–º–Ω–∞—è —Å—Ç–æ–ª–æ–≤–∞—è{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ</h1>
    <p class="page-subtitle">–í—ã–≥–æ–¥–Ω—ã–µ —Ç–∞—Ä–∏—Ñ—ã –∏ —É–¥–æ–±–Ω–∞—è –æ–ø–ª–∞—Ç–∞</p>
</div>

{% if active_subscription %}
<div class="alert alert-info">
    <div class="flex flex-between flex-center">
        <div>
            ‚úÖ <strong>–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞</strong> –¥–æ {{ active_subscription.end_date|date:"d.m.Y" }}
            <span class="text-muted">({{ active_subscription.get_meal_type_display }})</span>
        </div>
        <span class="badge badge-primary">{{ active_subscription.days_left }} –¥–Ω–µ–π –æ—Å—Ç–∞–ª–æ—Å—å</span>
    </div>
</div>
{% endif %}

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <div class="flex flex-between flex-center">
                <h2 class="card-title">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ —Å–≤–æ—é –ø–æ–¥–ø–∏—Å–∫—É</h2>
                <div class="text-right">
                    <div class="text-muted" style="font-size: 0.9rem;">–ë–∞–ª–∞–Ω—Å</div>
                    <div class="text-primary" style="font-weight: 700;">{{ user.balance }} ‚ÇΩ</div>
                </div>
            </div>
        </div>

        <form method="post">
            {% csrf_token %}

            <div class="mb-3">
                <label class="form-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</label>
                <div class="flex" style="gap: 0.5rem;">
                    <button type="button" class="btn btn-outline flex-1"
                            onclick="selectDuration('7')">
                        <div style="font-size: 1.25rem; font-weight: 600;">7</div>
                        <small class="text-muted">–¥–Ω–µ–π</small>
                    </button>
                    <button type="button" class="btn btn-outline flex-1"
                            onclick="selectDuration('14')">
                        <div style="font-size: 1.25rem; font-weight: 600;">14</div>
                        <small class="text-muted">–¥–Ω–µ–π</small>
                    </button>
                    <button type="button" class="btn btn-outline flex-1"
                            onclick="selectDuration('30')">
                        <div style="font-size: 1.25rem; font-weight: 600;">30</div>
                        <small class="text-muted">–¥–Ω–µ–π</small>
                    </button>
                </div>
                <input type="hidden" name="duration" id="duration" value="7">
            </div>

            <div class="mb-3">
                <label class="form-label">–¢–∏–ø –ø–∏—Ç–∞–Ω–∏—è</label>
                <div class="grid grid-3">
                    <button type="button" class="btn btn-outline" onclick="selectMealType('breakfast')">
                        <div style="font-size: 1.5rem;">üåÖ</div>
                        <div>–ó–∞–≤—Ç—Ä–∞–∫</div>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="selectMealType('lunch')">
                        <div style="font-size: 1.5rem;">üçΩÔ∏è</div>
                        <div>–û–±–µ–¥</div>
                    </button>
                    <button type="button" class="btn btn-outline" onclick="selectMealType('both')">
                        <div style="font-size: 1.5rem;">üåÖüçΩÔ∏è</div>
                        <div>–û–±–∞</div>
                    </button>
                </div>
                <input type="hidden" name="meal_type" id="meal_type" value="breakfast">
            </div>

            <div class="card" style="background: #FFF9C4; border: 2px solid #FFD700;">
                <div class="text-center" style="padding: 1.5rem;">
                    <div class="text-muted" style="margin-bottom: 0.5rem;">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏</div>
                    <div id="price" style="font-size: 2.5rem; font-weight: 700; color: #212121;">700 ‚ÇΩ</div>
                    <div class="text-muted" style="font-size: 0.9rem;">
                        <span id="duration_text">7 –¥–Ω–µ–π</span> ‚Ä¢
                        <span id="meal_type_text">—Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫</span>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <button type="submit" class="btn btn-primary btn-block">
                    <span style="margin-right: 0.5rem;">üí≥</span>
                    –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                </button>
            </div>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ —Ç–∞—Ä–∏—Ñ–∞</h2>
        </div>

        <div style="padding: 1rem 0;">
            <div class="flex flex-between flex-center" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-border);">
                <span class="text-muted">–ü–µ—Ä–∏–æ–¥</span>
                <span id="detail_duration" style="font-weight: 600;">7 –¥–Ω–µ–π</span>
            </div>
            <div class="flex flex-between flex-center" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-border);">
                <span class="text-muted">–ü–∏—Ç–∞–Ω–∏–µ</span>
                <span id="detail_meal" style="font-weight: 600;">–ó–∞–≤—Ç—Ä–∞–∫</span>
            </div>
            <div class="flex flex-between flex-center" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-border);">
                <span class="text-muted">–°—Ç–æ–∏–º–æ—Å—Ç—å –¥–Ω—è</span>
                <span id="detail_day_price" style="font-weight: 600;">100 ‚ÇΩ</span>
            </div>
            <div class="flex flex-between flex-center" style="padding: 0.75rem; border-bottom: 1px solid var(--gray-border);">
                <span class="text-muted">–≠–∫–æ–Ω–æ–º–∏—è</span>
                <span id="detail_saving" style="color: #10b981; font-weight: 600;">15%</span>
            </div>
            <div class="flex flex-between flex-center" style="padding: 0.75rem;">
                <span class="text-muted">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</span>
                <span id="detail_end_date" style="font-weight: 600;">-</span>
            </div>
        </div>

        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--gray-border);">
            <h3 style="margin-bottom: 0.75rem; font-size: 1rem;">üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞</h3>
            <ul class="text-muted" style="padding-left: 1.5rem;">
                <li>–§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ü–µ–Ω–∞ –Ω–∞ –≤–µ—Å—å –ø–µ—Ä–∏–æ–¥</li>
                <li>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è</li>
                <li>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –¥–Ω–∏</li>
                <li>–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ –ª—é–±—ã–º –≤–æ–ø—Ä–æ—Å–∞–º</li>
            </ul>
        </div>
    </div>
</div>

<div class="card mt-3">
    <div class="card-header">
        <h2 class="card-title">–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤</h2>
    </div>

    <div class="grid grid-3 text-center">
        <div style="padding: 1rem;">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">–†–∞–∑–æ–≤–æ</div>
            <div style="color: #ef4444; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">120 ‚ÇΩ/–¥–µ–Ω—å</div>
            <small class="text-muted">–ü–æ –º–µ–Ω—é –∫–∞–∂–¥—ã–π –¥–µ–Ω—å</small>
        </div>
        <div style="padding: 1rem; border-left: 1px solid var(--gray-border); border-right: 1px solid var(--gray-border);">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">–ü–æ–¥–ø–∏—Å–∫–∞</div>
            <div style="color: #10b981; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">100 ‚ÇΩ/–¥–µ–Ω—å</div>
            <small class="text-muted">–≠–∫–æ–Ω–æ–º–∏—è –¥–æ 20%</small>
        </div>
        <div style="padding: 1rem;">
            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">–ì–æ–¥–æ–≤–æ–π</div>
            <div style="color: #3b82f6; font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">85 ‚ÇΩ/–¥–µ–Ω—å</div>
            <small class="text-muted">–°–∞–º—ã–π –≤—ã–≥–æ–¥–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç</small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const prices = {
    '7': {'breakfast': 700, 'lunch': 1000, 'both': 1500},
    '14': {'breakfast': 1300, 'lunch': 1900, 'both': 2800},
    '30': {'breakfast': 2500, 'lunch': 3800, 'both': 5500}
};

const mealTypeNames = {
    'breakfast': '—Ç–æ–ª—å–∫–æ –∑–∞–≤—Ç—Ä–∞–∫',
    'lunch': '—Ç–æ–ª—å–∫–æ –æ–±–µ–¥',
    'both': '–∑–∞–≤—Ç—Ä–∞–∫ –∏ –æ–±–µ–¥'
};

const mealDisplayNames = {
    'breakfast': '–ó–∞–≤—Ç—Ä–∞–∫',
    'lunch': '–û–±–µ–¥',
    'both': '–ó–∞–≤—Ç—Ä–∞–∫ + –û–±–µ–¥'
};

const durationNames = {
    '7': '7 –¥–Ω–µ–π',
    '14': '14 –¥–Ω–µ–π',
    '30': '30 –¥–Ω–µ–π'
};

function selectDuration(duration) {
    document.getElementById('duration').value = duration;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('[onclick^="selectDuration"]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(`'${duration}'`)) {
            btn.classList.add('active');
        }
    });

    updatePrice();
}

function selectMealType(mealType) {
    document.getElementById('meal_type').value = mealType;

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫
    document.querySelectorAll('[onclick^="selectMealType"]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('onclick').includes(`'${mealType}'`)) {
            btn.classList.add('active');
        }
    });

    updatePrice();
}

function updatePrice() {
    const duration = document.getElementById('duration').value;
    const mealType = document.getElementById('meal_type').value;
    const price = prices[duration][mealType];

    // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–µ–Ω—É
    document.getElementById('price').textContent = price + ' ‚ÇΩ';
    document.getElementById('duration_text').textContent = durationNames[duration];
    document.getElementById('meal_type_text').textContent = mealTypeNames[mealType];

    // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏
    document.getElementById('detail_duration').textContent = durationNames[duration];
    document.getElementById('detail_meal').textContent = mealDisplayNames[mealType];

    // –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –¥–µ–Ω—å
    const dayPrice = Math.round(price / parseInt(duration));
    document.getElementById('detail_day_price').textContent = dayPrice + ' ‚ÇΩ';

    // –≠–∫–æ–Ω–æ–º–∏—è (–ø—Ä–∏–º–µ—Ä–Ω–∞—è)
    const saving = duration === '7' ? '15%' : duration === '14' ? '18%' : '20%';
    document.getElementById('detail_saving').textContent = saving;

    // –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è (—Ä–∞—Å—á–µ—Ç –≤ JS)
    const today = new Date();
    const endDate = new Date(today);
    endDate.setDate(today.getDate() + parseInt(duration));

    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã –≤ —Ä—É—Å—Å–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
    const day = endDate.getDate().toString().padStart(2, '0');
    const month = (endDate.getMonth() + 1).toString().padStart(2, '0');
    const year = endDate.getFullYear();
    document.getElementById('detail_end_date').textContent = `${day}.${month}.${year}`;
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –ø–µ—Ä–≤–æ–π –∫–Ω–æ–ø–∫–µ —Å—Ä–æ–∫–∞
    document.querySelector('[onclick="selectDuration(\'7\')"]').classList.add('active');
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å active –∫ –ø–µ—Ä–≤–æ–π –∫–Ω–æ–ø–∫–µ —Ç–∏–ø–∞ –ø–∏—Ç–∞–Ω–∏—è
    document.querySelector('[onclick="selectMealType(\'breakfast\')"]').classList.add('active');

    updatePrice();
});
</script>

<style>
.btn-outline.active {
    background-color: var(--yellow);
    border-color: var(--yellow);
    color: var(--text-dark);
}

.flex-1 {
    flex: 1;
}

.grid-3 {
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
}

.grid-3 .btn-outline {
    padding: 1rem 0.5rem;
    text-align: center;
    transition: all 0.2s;
}

.grid-3 .btn-outline:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}